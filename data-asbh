#!/bin/bash

# Script de lancement automatique pour MAMP + Flask + PHP
# Nom du fichier: launch_app.sh

echo "ğŸš€ DÃ©marrage de l'application..."

# Chemins des applications
MAMP_APP="/Applications/MAMP/MAMP.app"
FLASK_SCRIPT="/Applications/MAMP/htdocs/data_asbh-main/app2.py"
PHP_PAGE="/Applications/MAMP/htdocs/data_asbh-main/index.php"

# 1. Lancer MAMP
echo "ğŸ“± Lancement de MAMP..."
open "$MAMP_APP"

# Attendre que MAMP dÃ©marre (ajustez le dÃ©lai selon vos besoins)
echo "â³ Attente du dÃ©marrage de MAMP (10 secondes)..."
sleep 10

# 2. Lancer le serveur Flask en arriÃ¨re-plan
echo "ğŸ Lancement du serveur Flask..."
cd "/Applications/MAMP/htdocs/data_asbh-main"

# VÃ©rifier et installer Flask si nÃ©cessaire
echo "ğŸ” VÃ©rification de Flask..."

# Fonction pour installer les dÃ©pendances Flask
install_flask_deps() {
    echo "ğŸ“¦ Installation des dÃ©pendances Flask..."
    
    # Ajouter le PATH des scripts Python utilisateur
    export PATH="$HOME/Library/Python/3.9/bin:$PATH"
    
    # Installer Flask et flask-cors
    pip3 install --user flask flask-cors
    
    echo "âœ… DÃ©pendances installÃ©es"
}

# Tester si Flask et flask-cors sont disponibles
if ! python3 -c "import flask, flask_cors" 2>/dev/null; then
    echo "âš ï¸  DÃ©pendances Flask manquantes, installation en cours..."
    install_flask_deps
fi

# S'assurer que le PATH inclut les scripts Python
export PATH="$HOME/Library/Python/3.9/bin:$PATH"

# Lancer Flask avec gestion d'erreur
echo "ğŸš€ DÃ©marrage du serveur Flask..."
if python3 -c "import flask" 2>/dev/null; then
    python3 "$FLASK_SCRIPT" &
    FLASK_PID=$!
    echo "âœ… Serveur Flask dÃ©marrÃ© (PID: $FLASK_PID)"
else
    echo "âŒ Impossible de lancer Flask. VÃ©rifiez l'installation."
    echo "ğŸ’¡ Solution alternative: utilisez l'environnement virtuel"
    exit 1
fi

# 3. Attendre un peu puis ouvrir la page PHP dans le navigateur
echo "â³ Attente du dÃ©marrage du serveur Flask (5 secondes)..."
sleep 5

echo "ğŸŒ Ouverture de la page principale..."
# Supposons que MAMP utilise le port par dÃ©faut 8888
open "http://localhost:8888/data_asbh-main/index.php"

echo "âœ… Application lancÃ©e avec succÃ¨s!"
echo "ğŸ“ Pour arrÃªter l'application, fermez MAMP et tuez le processus Flask (PID: $FLASK_PID)"

# Optionnel: garder le script ouvert pour afficher les logs
echo "ğŸ’¡ Appuyez sur Ctrl+C pour arrÃªter le serveur Flask"
wait $FLASK_PID
